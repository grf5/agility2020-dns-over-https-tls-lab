<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>5.2. Proxying DNS over HTTPS Queries to Traditional DNS</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="5.2. Proxying DNS over HTTPS Queries to Traditional DNS"/>
  <meta name="product" content="DNS over HTTPS / DNS over TLS"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="None"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="DNS over HTTPS / DNS over TLS" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.2. Proxying DNS over HTTPS Queries to Traditional DNS &#8212; DNS over HTTPS / DNS over TLS  documentation</title>
    
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/f5_agility_theme.css" type="text/css" />
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="/assets/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="/assets/css/index.css" type="text/css" />
    <link rel="stylesheet" href="/assets/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="/assets/css/CoveoFullSearch.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.3. Proxying DNS over TLS Queries to Traditional DNS" href="../module2/module2.html" />
    <link rel="prev" title="5.1. BIG-IP Configuration Review" href="../module0/module0.html" /> 
  </head>
  <body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      <!-- javascript code to maintain the sidebar scroll positon when loaded -->
      <script type="text/javascript">
        $(function() {
          if (localStorage.tempScrollTop) {
            $('#sidebar').scrollTop(localStorage.tempScrollTop);
          }
        });
        $('#sidebar').on("scroll", function() {
          localStorage.setItem("tempScrollTop", $('#sidebar').scrollTop());
        });
      </script>
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>DNS over HTTPS / DNS over TLS  </h5>
        
<div id="searchbox" role="search">
  <form class="search" action="../../search.html" method="get">
    <input type="text" class="search" name="q" placeholder=" Search..." />
    <button type="submit" class="btn btn-info navbar-btn"><i class="fa fa-search"></i></button>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../topology.html">2. Topology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components.html">3. Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../access.html">4. Accessing the Lab</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class1.html">5. Lab Goals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../module0/module0.html">5.1. BIG-IP Configuration Review</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.2. Proxying DNS over HTTPS Queries to Traditional DNS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module2/module2.html">5.3. Proxying DNS over TLS Queries to Traditional DNS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module3/module3.html">5.4. Proxying Traditional DNS to DNS over TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module4/module4.html">5.5. Proxying Traditional DNS queries to DNS over HTTPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resources.html">5.6. Additional Resources</a></li>
</ul>
</li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">5.2. Proxying DNS over HTTPS Queries to Traditional DNS</a><ul>
<li><a class="reference internal" href="#certificate-requirements-for-doh-dot-virtual-servers">5.2.1. Certificate Requirements for DoH/DoT Virtual Servers</a></li>
<li><a class="reference internal" href="#test-driving-dns-over-https-to-traditional-dns">5.2.2. Test Driving DNS over HTTPS to Traditional DNS</a></li>
<li><a class="reference internal" href="#firefox-configuration">5.2.3. Firefox Configuration</a></li>
<li><a class="reference internal" href="#firefox-network-utilities">5.2.4. Firefox Network Utilities</a></li>
<li><a class="reference internal" href="#doh-in-action">5.2.5. DoH in Action</a></li>
<li><a class="reference internal" href="#big-ip-statistics-and-logging">5.2.6. BIG-IP Statistics and Logging</a></li>
<li><a class="reference internal" href="#capturing-dns-over-https-queries-to-traditional-dns-traffic">5.2.7. Capturing DNS over HTTPS Queries to Traditional DNS Traffic</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
            <nav class="site-breadcrumb-nav site-nav">
          <ul class="site-breadcrumb-list">
            <li class="breadcrumb-item"><button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn site-hidden"><i class="fa fa-align-justify"></i></button>&#x20 <a href="/">Community Training Classes &amp; Labs</a> &gt; <a href="../../index.html">DNS over HTTPS / DNS over TLS </a> &gt; 5.2. Proxying DNS over HTTPS Queries to Traditional DNS</li>
          </ul>
      </nav>
      
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="proxying-dns-over-https-queries-to-traditional-dns">
<h1>5.2. Proxying DNS over HTTPS Queries to Traditional DNS<a class="headerlink" href="#proxying-dns-over-https-queries-to-traditional-dns" title="Permalink to this headline">¶</a></h1>
<div class="section" id="certificate-requirements-for-doh-dot-virtual-servers">
<h2>5.2.1. Certificate Requirements for DoH/DoT Virtual Servers<a class="headerlink" href="#certificate-requirements-for-doh-dot-virtual-servers" title="Permalink to this headline">¶</a></h2>
<p>DNS over HTTPS requires a valid server-side certificate. In our lab, we
created a self-signed CA certificate as well as a self-signed
certificate for the server. We loaded those certificates in your Firefox
browser so that the browser will trust the BIG-IP DoH resolver.</p>
<p>In a real-world scenario, you would need a certificate signed by a
well-known certificate authority and loaded into the BIG-IP and attached
to the client-ssl profile in use for DoH/DoT listeners. Most DoH
clients, including Firefox, will not trust a DoH server if the
certificate is not signed by a known certificate authority.</p>
</div>
<div class="section" id="test-driving-dns-over-https-to-traditional-dns">
<h2>5.2.2. Test Driving DNS over HTTPS to Traditional DNS<a class="headerlink" href="#test-driving-dns-over-https-to-traditional-dns" title="Permalink to this headline">¶</a></h2>
<p>Now, let’s generate some traffic and see the translations in real-time.</p>
</div>
<div class="section" id="firefox-configuration">
<h2>5.2.3. Firefox Configuration<a class="headerlink" href="#firefox-configuration" title="Permalink to this headline">¶</a></h2>
<p>For this test, we’re going to use Firefox as our DoH client. Click the
second tab in Firefox to view the <a class="reference external" href="about:config">about:config</a> page. On the top of that
page, you’ll see a search box. Enter <em>trr</em> and press enter to see the
DoH (trusted recursive resolver) configuration.</p>
<p><a class="reference internal" href="../../_images/image210.png"><img alt="image2.png" src="../../_images/image210.png" style="width: 7.5in; height: 4.6875in;" /></a></p>
<p>We’ve pre-configured a few things for you. First, we set
<em>network.trr.uri</em> to our custom virtual server URL. We also enabled
<em>network.trr.useGET</em> as it’s a bit faster than using POST, but you’re
welcome to test using POST as well. We set <em>network.trr.mode</em> to 3,
which means we want Firefox to <strong>only</strong> use DoH. This will not be a
typical configuration as Firefox defaults to traditional DNS when a DoH
request fails. That explains the differing timeout values just below
that setting. The <em>network.dns.skipTRR-when-parental-control-enabled</em>
disables Firefox’s feature that disables DoH when parental control via
DNS is sensed on the network.</p>
<p><strong>Please keep in mind that these settings are changing as Firefox
continues testing DoH. The ink on the RFC is still wet, technically, and
those heavily involved in encrypted DNS are still working out the
nuances.</strong></p>
</div>
<div class="section" id="firefox-network-utilities">
<h2>5.2.4. Firefox Network Utilities<a class="headerlink" href="#firefox-network-utilities" title="Permalink to this headline">¶</a></h2>
<p>Clicking on the third tab in Firefox will open the networking tools page
within the browser. This is a great way to see if DoH (TRR in
Mozilla-speak) is working. Click on <em>DNS Lookup</em> to bring up the DNS
query tool.</p>
<p><a class="reference internal" href="../../_images/image310.png"><img alt="image3.png" src="../../_images/image310.png" style="width: 7.5in; height: 4.6875in;" /></a></p>
<p>Entering a URL and clicking <em>Resolve</em> will show the A/AAAA records
returned for that FQDN.</p>
<p><a class="reference internal" href="../../_images/image42.png"><img alt="image4.png" src="../../_images/image42.png" style="width: 7.5in; height: 4.47917in;" /></a></p>
<p>If you then click on <em>DNS</em>, you’ll be presented with a table of the
current in-browser DNS cache. Click on <em>Refresh</em> to update the view. You
can see in the output below that TRR was <em>true</em> for the queries sent,
meaning DoH was used to resolve those hostnames.</p>
<p><a class="reference internal" href="../../_images/image51.png"><img alt="image5.png" src="../../_images/image51.png" style="width: 7.5in; height: 4.48438in;" /></a></p>
</div>
<div class="section" id="doh-in-action">
<h2>5.2.5. DoH in Action<a class="headerlink" href="#doh-in-action" title="Permalink to this headline">¶</a></h2>
<p>Open a new tab and browse to a website. Return to the third tab and
click <em>Refresh</em> to see the updated DNS cache table.</p>
<p><a class="reference internal" href="../../_images/image61.png"><img alt="image6.png" src="../../_images/image61.png" style="width: 7.5in; height: 4.4775in;" /></a></p>
</div>
<div class="section" id="big-ip-statistics-and-logging">
<h2>5.2.6. BIG-IP Statistics and Logging<a class="headerlink" href="#big-ip-statistics-and-logging" title="Permalink to this headline">¶</a></h2>
<p>Back in the first tab on the F5 web UI, navigate to <strong>Statistics</strong> -&gt;
<strong>Module Statistics</strong> -&gt; <strong>Local Traffic</strong>. Make sure that <em>Virtual
Servers</em> is selected in the <em>Statistics Type</em> drop-down. Observe the
traffic statistics on the DoH-to-DNS virtual server.</p>
<p><a class="reference internal" href="../../_images/image71.png"><img alt="image7.png" src="../../_images/image71.png" style="width: 2.39879in; height: 2.88051in;" /></a></p>
<p>Change the <em>Statistics Type</em> to iRulesLX and you can see how many RPC
connections have been made.</p>
<p><a class="reference internal" href="../../_images/image81.png"><img alt="image8.png" src="../../_images/image81.png" style="width: 7.5in; height: 4.47917in;" /></a></p>
<p>Change the drop-down to <em>Pools</em>. You should notice that the back-end
pools show 0 connections. Why? Because iRulesLX is talking to the
back-end DoH resolvers directly. You could point your DoH iRule to a
local VIP with a DNS pool for better performance, stability, etc. but
that is outside the scope of this lab.</p>
<p><a class="reference internal" href="../../_images/image91.png"><img alt="image9.png" src="../../_images/image91.png" style="width: 7.5in; height: 4.47917in;" /></a></p>
<p>Navigate to <strong>System</strong> -&gt; <strong>Logs</strong> -&gt; <strong>Local Traffic</strong>. Notice that
some useful information is being logged to help show the parsing and
querying that is taking place behind the scenes.</p>
<p><a class="reference internal" href="../../_images/image101.png"><img alt="image10.png" src="../../_images/image101.png" style="width: 7.5in; height: 3.89006in;" /></a></p>
</div>
<div class="section" id="capturing-dns-over-https-queries-to-traditional-dns-traffic">
<h2>5.2.7. Capturing DNS over HTTPS Queries to Traditional DNS Traffic<a class="headerlink" href="#capturing-dns-over-https-queries-to-traditional-dns-traffic" title="Permalink to this headline">¶</a></h2>
<p>Finally, minimize <em>Firefox</em> to reveal the CLI shortcuts on the desktop:</p>
<p><a class="reference internal" href="../../_images/image111.png"><img alt="image11.png" src="../../_images/image111.png" style="width: 7.5in; height: 4.47917in;" /></a></p>
<p>Let’s open the BIG-IP DNS Proxy link to bring up the BIG-IP’s CLI. Once
running, let’s start a capture that will show us both sides of the DoH
proxy:</p>
<p>tcpdump -nni 0.0 (host 10.1.1.4 and host 10.1.10.100 and port 443) or
(host 8.8.4.4 or host 8.8.8.8 and port 53)</p>
<p>Once running, maximize <em>Firefox</em> and perform another DNS lookup. View
the HTTPS and DNS traffic in the packet capture output. The output below
shows my queries to f5.com, f5agility.com and disney.com.</p>
<p><a class="reference internal" href="../../_images/image121.png"><img alt="image12.png" src="../../_images/image121.png" style="width: 7.5in; height: 4.47396in;" /></a></p>
<p>Stop your capture before moving to the next section. This concludes the
DoH-to-DNS proxy portion of the lab.</p>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="../module0/module0.html" title="5.1. BIG-IP Configuration Review" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="../module2/module2.html" title="5.3. Proxying DNS over TLS Queries to Traditional DNS" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>
  <script src="/assets/js/clouddocs.js"></script>
  <script src="/assets/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>